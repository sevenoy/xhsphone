<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>小红书手机号整理 · 协作表格（苹果风 v6）</title>
<style>
  :root{
    --bg:#fff;--fg:#111418;--muted:#6e6e73;--line:#e5e5ea;--blue:#007aff;--blue-press:#0063cc;
    --cell:#fff;--cell-alt:#f5f5f7;
    --pad:6px;                 /* 行内上下内边距（行高控制） */
    --colScale:1;              /* 列宽缩放系数 */
    --zebra:#eef5ff;           /* 隔行颜色 */
    --w-phone:160px;--w-owner:120px;--w-real:120px;--w-wx:160px;--w-xhs:340px;--w-note:220px;--w-cat:140px;--w-actions:140px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Helvetica Neue",Helvetica,Arial,"PingFang SC","Noto Sans CJK SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  .wrap{max-width:1280px;margin:0 auto;padding:12px}
  h1{font-size:18px;font-weight:700;margin:0 0 8px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  input,select,button{height:32px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--fg);padding:0 10px}
  input[type=file]{display:none}
  button{background:var(--blue);border:none;color:#fff;padding:0 12px;cursor:pointer;transition:background .15s}
  button.ghost{background:#f2f2f7;color:#000}
  button:active{background:var(--blue-press)}
  .badge{font-variant-numeric:tabular-nums;border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted)}
  .panel{background:var(--cell);border:1px solid var(--line);border-radius:14px;padding:10px;margin:10px 0}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:var(--pad) 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  th{position:sticky;top:0;background:#f9f9fb;font-weight:600;z-index:2}
  /* 让隔行着色覆盖所有单元格 */
  tbody.zebra tr:nth-child(even) td{ background: var(--zebra); }
  /* 编辑态只在 focus 时淡灰，避免盖住斑马纹 */
  td[contenteditable='true']{background:transparent; outline:none}
  td[contenteditable='true']:focus{background:var(--cell-alt); outline:1px solid var(--line)}
  .status{font-size:12px;color:var(--muted);margin-top:6px;white-space:pre-wrap}
  .rgbaChip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .colorDot{width:14px;height:14px;border-radius:4px;border:1px solid #c9c9ce;display:inline-block}
  /* 列宽随全局比例缩放 */
  th.col-phone, td.col-phone{ width: calc(var(--w-phone) * var(--colScale)); }
  th.col-owner, td.col-owner{ width: calc(var(--w-owner) * var(--colScale)); }
  th.col-real,  td.col-real{  width: calc(var(--w-real)  * var(--colScale)); }
  th.col-wx,    td.col-wx{    width: calc(var(--w-wx)    * var(--colScale)); }
  th.col-xhs,   td.col-xhs{   width: calc(var(--w-xhs)   * var(--colScale)); }
  th.col-note,  td.col-note{  width: calc(var(--w-note)  * var(--colScale)); }
  th.col-cat,   td.col-cat{   width: calc(var(--w-cat)   * var(--colScale)); }
  th.col-act,   td.col-act{   width: calc(var(--w-actions)* var(--colScale)); }
  /* 行内编辑浮层 */
  td.col-act{ position:relative; overflow:visible; }
  .edit-bar{display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);gap:6px;background:#f2f2f7;border-radius:12px;padding:6px;box-shadow:0 6px 14px rgba(0,0,0,.08);z-index:3}
  .row-editing .edit-bar{display:flex}
</style>

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">


<!-- === Password Gate (overlay only, zero layout changes) === -->
<style>
  #x_gate_overlay{
    position:fixed; inset:0; z-index:2147483647;
    background:#0b0d10; display:flex; align-items:center; justify-content:center;
  }
  #x_gate_box{
    width:360px; max-width:92%; border-radius:12px; background:#fff; padding:18px;
    box-shadow:0 18px 40px rgba(0,0,0,0.35);
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
  }
  #x_gate_box h2{ margin:0 0 8px; font-size:18px; }
  #x_gate_box p{ margin:0 0 12px; color:#444; font-size:13px; }
  #x_gate_box input[type="password"]{ width:100%; height:40px; padding:6px 10px; font-size:15px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box; }
  #x_gate_box .row{ display:flex; gap:8px; margin-top:12px; }
  #x_gate_box button{ flex:1; height:40px; border-radius:8px; border:none; background:#007aff; color:#fff; cursor:pointer; font-weight:600; }
  #x_gate_box .btn-ghost{ background:#f2f2f7; color:#000; }
  #x_gate_msg{ height:18px; margin-top:8px; color:#b22222; font-size:13px; text-align:center; }
</style>

</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <h1>小红书手机号整理 · 协作表格（苹果风 v6）</h1>
      <div class="status">整行隔行着色 · 分类背景只作用于“小红书名称”一格（透明度0.18） · 紧凑行高 · 行/列尺寸可调 · 单备注</div>
    </div>
    <div><a class="badge" href="https://gitee.com/sevenoy" target="_blank" rel="noopener">Gitee：sevenoy</a></div>
  </div>

  <div class="panel">
    <div class="toolbar">
      <input id="q" placeholder="搜索：任意关键词" style="flex:1 1 280px" />
      <select id="filterOwner"><option value="all">所属人：全部</option></select>
      <select id="filterWxReal"><option value="all">微信实名人：全部</option></select>
      <select id="sortBy">
        <option value="order">排序：手动</option>
        <option value="owner">排序：所属人</option>
        <option value="wx_real">排序：微信实名人</option>
        <option value="phone">排序：电话号码</option>
        <option value="xhs_name">排序：小红书名称</option>
        <option value="row_color">排序：分类</option>
      </select>
      <button id="btnAdd">+ 新增一行</button>
      <button id="btnImportCSV">导入 CSV</button>
      <input id="csvFile" type="file" accept=".csv,text/csv" />
      <button id="btnExport" class="ghost">导出 JSON</button>
      <button id="btnClearAll" class="ghost">清空全部</button>
      <button id="btnCategories" class="ghost">分类设置</button>
      <button id="btnView" class="ghost">显示与尺寸</button>
      
      <button id="btnDebug" class="ghost">日志</button>
    </div>
    <div class="status" id="statusText">本地模式：不联网 · 支持 CSV 导入 / JSON 导出</div>
  </div>

  <div class="panel" style="overflow:auto;max-height:92vh">
    <table id="grid">
      <thead>
        <tr>
          <th class="col-phone">电话号码</th>
          <th class="col-owner">所属人</th>
          <th class="col-real">微信实名人</th>
          <th class="col-wx">对应微信名</th>
          <th class="col-xhs">小红书名称</th>
          <th class="col-note">备注</th>
          <th class="col-cat">分类</th>
          <th class="col-act">操作</th>
        </tr>
      </thead>
      <tbody id="gridBody" class="zebra"></tbody>
    </table>
  </div>

  <!-- 分类设置 -->
  <div class="panel" id="panelCategories" style="display:none">
    <div class="toolbar" style="align-items:flex-start">
      <div class="rgbaChip"><span class="colorDot" id="catColorPreview"></span><input id="catName" placeholder="分类名称，例如：Olina用" style="width:180px"><input id="catColor" type="color" value="#007aff" style="width:60px;padding:0 2px"></div>
      <button id="btnCatAdd">新增分类</button>
      <div class="status">设置后将改变<b>小红书名称</b>这一格的<strong>背景色</strong>（透明度 0.18）。</div>
    </div>
    <div id="catList"></div>
  </div>

  <!-- 显示与尺寸设置 -->
  <div class="panel" id="panelView" style="display:none">
    <div class="toolbar">
      <label>行高</label>
      <input id="rowPad" type="range" min="4" max="14" step="1" value="6" style="width:160px">
      <label>列宽缩放</label>
      <input id="colScale" type="range" min="0.7" max="1.4" step="0.05" value="1" style="width:160px">
      <label>隔行着色</label>
      <input id="zebraOn" type="checkbox" checked>
      <input id="zebraColor" type="color" value="#eef5ff">
      <button id="btnCompact" class="ghost">一键紧凑</button>
      <button id="btnResetSize" class="ghost">恢复默认</button>
    </div>
  </div>
</div>

  <!-- 调试日志 -->
  <div class="panel" id="panelDebug" style="display:none"><div class="status" id="debug"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>

<script>
  // 兼容：确保 $ / $$ 已定义（在任何事件绑定之前）
  (function(){
    if (typeof window.$ === 'undefined') {
      window.$  = (q, s=document) => s.querySelector(q);
    }
    if (typeof window.$$ === 'undefined') {
      window.$$ = (q, s=document) => Array.from(s.querySelectorAll(q));
    }
  })();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  // ===== 视图设置（行高/列宽/斑马纹） =====
  const readView=()=>{ try{ return JSON.parse(localStorage.getItem('view_v6'))||{} }catch{ return {} } };
  const saveView=(v)=>localStorage.setItem('view_v6', JSON.stringify(v));
  function applyView(v){
    document.documentElement.style.setProperty('--pad', (v.pad??6)+'px');
    document.documentElement.style.setProperty('--colScale', v.colScale??1);
    document.documentElement.style.setProperty('--zebra', v.zebraColor||'#eef5ff');
    const body=$('#gridBody');
    if(v.zebraOn===false){ body.classList.remove('zebra'); } else { body.classList.add('zebra'); }
    $('#rowPad').value = v.pad??6; $('#colScale').value = v.colScale??1;
    $('#zebraOn').checked = !(v.zebraOn===false); $('#zebraColor').value = v.zebraColor||'#eef5ff';
  }
  const view = readView(); applyView(view);
  $('#rowPad').oninput=(e)=>{ view.pad=parseInt(e.target.value,10); applyView(view); saveView(view); };
  $('#colScale').oninput=(e)=>{ view.colScale=parseFloat(e.target.value); applyView(view); saveView(view); };
  $('#zebraOn').onchange=(e)=>{ view.zebraOn=e.target.checked; applyView(view); saveView(view); };
  $('#zebraColor').oninput=(e)=>{ view.zebraColor=e.target.value; applyView(view); saveView(view); };

  // ===== 分类 =====
  const DEFAULT_CATS=[
    {key:'enterprise', name:'企业号', color:'#ffd60a'},
    {key:'olina',      name:'Olina用', color:'#007aff'},
    {key:'jasper',     name:'嘉用',   color:'#af52de'},
    {key:'usable',     name:'可用',   color:'#34c759'}
  ];
  const readCats=()=>{ try{ return JSON.parse(localStorage.getItem('cats_v6'))||DEFAULT_CATS; }catch{ return DEFAULT_CATS; } };
  const saveCats=(c)=>localStorage.setItem('cats_v6', JSON.stringify(c));
  function renderCatList(){ const cats=readCats(); const box=$('#catList'); box.innerHTML=''; cats.forEach((c,idx)=>{ const row=document.createElement('div'); row.className='toolbar'; row.innerHTML=`
      <span class="rgbaChip"><span class="colorDot" style="background:${c.color}"></span>${c.name}</span>
      <button data-act="up" data-i="${idx}" class="ghost">上移</button>
      <button data-act="down" data-i="${idx}" class="ghost">下移</button>
      <button data-act="edit" data-i="${idx}" class="ghost">改名/颜色</button>
      <button data-act="del" data-i="${idx}" class="ghost">删除</button>`; box.appendChild(row); }); }
  function ensureCatOptions(){ const cats=readCats(); const opts=['<option value=\"\">无</option>'].concat(cats.map(c=>`<option value="${c.key}">${c.name}</option>`)).join(''); $$('#gridBody select[data-k="row_color"]').forEach(sel=>{ const cur=sel.value; sel.innerHTML=opts; sel.value=cur; }); refreshFilters(); }
  const catColorOf=(key)=>{ const c=readCats().find(x=>x.key===key); return c?c.color:null; };
  const catNameOf=(key)=>{ const c=readCats().find(x=>x.key===key); return c?c.name:''; };
  function hexToRgba(hex, a){ hex=(hex||'').replace('#',''); if(hex.length===3) hex=hex.split('').map(x=>x+x).join(''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }

  // ===== DB =====
  const dbLocal=new Dexie('xhs_phone_sheet_v6');
  dbLocal.version(2).stores({ rows:'id, order, phone, owner, wx_real, wx_name, xhs_name, note1, row_color, updated_at' });

  // ===== 行渲染 =====
  function makeRowTr(r){
    const tr=document.createElement('tr'); tr.dataset.id=r.id; tr.dataset.order=r.order||0;
    const bg = r.row_color ? hexToRgba(catColorOf(r.row_color)||'#ffffff', .18) : '';
    tr.innerHTML=`
      <td class="col-phone" contenteditable="true" data-k="phone">${r.phone||''}</td>
      <td class="col-owner" contenteditable="true" data-k="owner">${r.owner||''}</td>
      <td class="col-real"  contenteditable="true" data-k="wx_real">${r.wx_real||''}</td>
      <td class="col-wx"    contenteditable="true" data-k="wx_name">${r.wx_name||''}</td>
      <td class="col-xhs"   contenteditable="true" data-k="xhs_name" style="${bg?`background:${bg};`:''}">${r.xhs_name||''}</td>
      <td class="col-note"  contenteditable="true" data-k="note1">${r.note1||''}</td>
      <td class="col-cat"><select data-k="row_color"></select></td>
      <td class="col-act">
        <button data-act="toggleEdit" class="ghost">编辑</button>
        <div class="edit-bar">
          <button data-act="up" class="ghost">上移</button>
          <button data-act="down" class="ghost">下移</button>
          <button data-act="del" class="ghost">删除</button>
        </div>
      </td>`;
    return tr;
  }

  async function render(){
    const kw=($('#q').value||'').trim().toLowerCase();
    const fOwner=$('#filterOwner').value; const fWx=$('#filterWxReal').value;
    const sortBy=$('#sortBy').value;
    let all=await dbLocal.rows.toArray();

    all=all.filter(r=>{
      if(fOwner!=='all' && (r.owner||'')!==fOwner) return false;
      if(fWx!=='all' && (r.wx_real||'')!==fWx) return false;
      if(!kw) return true;
      const t=[r.phone,r.owner,r.wx_real,r.wx_name,r.xhs_name,r.note1,catNameOf(r.row_color)].join(' ').toLowerCase();
      return t.includes(kw);
    });

    const collator=new Intl.Collator('zh-Hans-CN',{numeric:true,sensitivity:'base'});
    if(sortBy==='order') all.sort((a,b)=> (a.order||0)-(b.order||0));
    else all.sort((a,b)=> collator.compare(String(a[sortBy]||''), String(b[sortBy]||'')));

    const body=$('#gridBody'); body.innerHTML='';
    all.forEach(r=> body.appendChild(makeRowTr(r)));
    ensureCatOptions();
    $$('#gridBody tr').forEach(tr=>{ const id=tr.dataset.id; dbLocal.rows.get(id).then(r=>{ const sel=tr.querySelector('select[data-k="row_color"]'); if(sel) sel.value=r && r.row_color ? r.row_color : ''; }); });
    refreshFilters();
  }

  async function refreshFilters(){
    const all=await dbLocal.rows.toArray();
    const owners=[...new Set(all.map(r=>r.owner).filter(Boolean))];
    const reals=[...new Set(all.map(r=>r.wx_real).filter(Boolean))];
    const oSel=$('#filterOwner'); const saveO=oSel.value; oSel.innerHTML='<option value="all">所属人：全部</option>'+owners.map(v=>`<option value="${v}">${v}</option>`).join(''); oSel.value=owners.includes(saveO)?saveO:'all';
    const wSel=$('#filterWxReal'); const saveW=wSel.value; wSel.innerHTML='<option value="all">微信实名人：全部</option>'+reals.map(v=>`<option value="${v}">${v}</option>`).join(''); wSel.value=reals.includes(saveW)?saveW:'all';
  }

  // CRUD
  async function addRowLocal(){ const count=await dbLocal.rows.count(); const r={ id:crypto.randomUUID(), order:count+1, phone:'', owner:'', wx_real:'', wx_name:'', xhs_name:'', note1:'', row_color:'', created_at:new Date().toISOString(), updated_at:new Date().toISOString() }; await dbLocal.rows.put(r); await render(); }
  async function updateCellLocal(id,key,value){ const r=await dbLocal.rows.get(id); if(!r) return; const patch={}; patch[key]=value; patch.updated_at=new Date().toISOString(); await dbLocal.rows.update(id, patch); await render(); }
  async function deleteRowLocal(id){ await dbLocal.rows.delete(id); await render(); }
  async function moveRow(id, dir){ const all=await dbLocal.rows.orderBy('order').toArray(); const idx=all.findIndex(x=>x.id===id); if(idx<0) return; const tgt=dir==='up'? idx-1:idx+1; if(tgt<0||tgt>=all.length) return; const a=all[idx], b=all[tgt]; await dbLocal.rows.update(a.id,{order:b.order,updated_at:new Date().toISOString()}); await dbLocal.rows.update(b.id,{order:a.order,updated_at:new Date().toISOString()}); await render(); }

  // CSV 导入（清理 nan/null/-）
  function parseCSV(text, delim){ const rows=[]; let cur='', inQ=false, row=[]; for(let i=0;i<text.length;i++){ const ch=text[i], next=text[i+1]; if(ch=='"'){ if(inQ && next=='"'){ cur+='"'; i++; } else inQ=!inQ; } else if(ch===delim && !inQ){ row.push(cur); cur=''; } else if((ch=='\n'||ch=='\r') && !inQ){ if(cur!==''||row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } if(ch=='\r' && next=='\n'){ i++; } } else { cur+=ch; } } if(cur!==''||row.length){ row.push(cur); rows.push(row); } return rows; }
  function detectDelimiter(text){ const sample=text.slice(0,10000); const cand=[',','\t',';','|']; const cnt={',':0,'\t':0,';':0,'|':0}; let inQ=false; for(let i=0;i<sample.length;i++){ const ch=sample[i]; if(ch=='"'){ inQ=!inQ; continue; } if(!inQ && cnt.hasOwnProperty(ch)) cnt[ch]++; } let best=',',max=-1; for(const k of cand){ if(cnt[k]>max){ max=cnt[k]; best=k; } } return best; }
  function mapHeader(h){ const t=(h||'').toLowerCase().trim(); const table={ phone:['电话号码','电话','手机号','phone','mobile','号码'], owner:['所属人','owner','归属','持有人'], wx_real:['微信实名人','实名人','wx_real','微信实名'], wx_name:['对应微信名','微信名','wx_name'], xhs_name:['小红书名称','小红书名','xhs','xhs_name'], note1:['备注','备注1','note','note1'], row_color:['分类','颜色','row_color','color','类别'] }; for(const k in table){ if(table[k].some(x=>t.includes(x))) return k; } return null; }
  async function importCSVText(text){ const delim=detectDelimiter(text); const rows=parseCSV(text, delim); let headerRow=0; for(let i=0;i<Math.min(rows.length,20);i++){ const j=(rows[i]||[]).join(' ').toLowerCase(); if(j.includes('电话')||j.includes('phone')||j.includes('小红书')||j.includes('备注')){ headerRow=i; break; } } if(headerRow>0){ rows.splice(0, headerRow); } const headers=(rows[0]||[]).map(mapHeader); if(!headers.some(h=>h==='phone')){ alert('没有找到“电话号码/phone”的表头'); return; } const count=await dbLocal.rows.count();
    const existingRows = await dbLocal.rows.toArray();
    const normPhone = (p)=>String(p||'').replace(/\D+/g,'');
    const existed = new Set(existingRows.map(r=>normPhone(r.phone)));
    const seen = new Set();
    let skipped=0; const data=[]; for(let i=1;i<rows.length;i++){ const r=rows[i]||[]; if(r.every(c=>String(c||'').trim()==='')) continue; const obj={ id:crypto.randomUUID(), order:count+i, created_at:new Date().toISOString(), updated_at:new Date().toISOString() }; headers.forEach((k,idx)=>{ if(!k) return; const raw = (r[idx]===undefined ? '' : String(r[idx])); const v = raw.trim(); const low=v.toLowerCase(); obj[k] = (low==='nan'||low==='null'||low==='-'? '' : v); });       const key = normPhone(obj.phone);
      if (key && (existed.has(key) || seen.has(key))) { skipped++; }
      else { if (key) seen.add(key); data.push(obj); } } if(!data.length){ alert('没有可导入的数据'); return; } await dbLocal.rows.bulkPut(data); await render(); alert('本地已导入 '+data.length+' 行，跳过重复 '+skipped+' 行（按电话号码去重）'); }

  // 事件
  $('#btnImportCSV').onclick=()=> $('#csvFile').click();
  $('#csvFile').onchange=async (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const text=await f.text(); await importCSVText(text); e.target.value=''; };
  $('#btnAdd').onclick=addRowLocal;
  $('#btnExport').onclick=async ()=>{ const rows=await dbLocal.rows.toArray(); const blob=new Blob([JSON.stringify(rows,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='xhs-phones-'+Date.now()+'.json'; a.click(); };
  $('#btnClearAll').onclick=async ()=>{ if(!confirm('确定清空全部数据？此操作不可撤销。')) return; await dbLocal.rows.clear(); await render(); alert('已清空全部数据'); };
  $('#q').oninput=render; $('#filterOwner').onchange=render; $('#filterWxReal').onchange=render; $('#sortBy').onchange=render;
  $('#btnCategories').onclick=()=>{ const p=$('#panelCategories'); p.style.display=p.style.display==='none'?'block':'none'; if(p.style.display==='block'){ renderCatList(); ensureCatOptions(); } };
  $('#btnView').onclick=()=>{ const p=$('#panelView'); p.style.display=p.style.display==='none'?'block':'none'; };
  $('#btnDebug').onclick=()=>{ const p=$('#panelDebug'); p.style.display=p.style.display==='none'?'block':'none'; };

  // 表格委托
  $('#gridBody').addEventListener('blur', async (e)=>{ const td=e.target.closest('[contenteditable="true"]'); if(!td) return; const tr=e.target.closest('tr'); const id=tr.dataset.id; const key=td.dataset.k; const val=td.innerText.trim(); await updateCellLocal(id, key, val); }, true);
  $('#gridBody').addEventListener('change', async (e)=>{ const sel=e.target.closest('select[data-k]'); if(!sel) return; const tr=sel.closest('tr'); await updateCellLocal(tr.dataset.id, sel.dataset.k, sel.value); });
  $('#gridBody').addEventListener('click', async (e)=>{
    const btn=e.target.closest('button[data-act]'); if(!btn) return;
    const tr=btn.closest('tr'); const id=tr.dataset.id; const act=btn.dataset.act;
    if(act==='toggleEdit'){ tr.classList.toggle('row-editing'); return; }
    if(act==='del'){ if(confirm('确认删除该行？')) await deleteRowLocal(id); return; }
    if(act==='up'){ await moveRow(id,'up'); return; }
    if(act==='down'){ await moveRow(id,'down'); return; }
  });

  // 初始化
  (async()=>{ await dbLocal.open(); await render(); })();
});
</script>

<script>
// === Category Manager Hotfix (non-invasive) ===
(function(){
  const LS_KEY='cats_v6';
  const DEFAULT_CATS=[
    {key:'enterprise', name:'企业号', color:'#ffd60a'},
    {key:'olina',      name:'Olina用', color:'#007aff'},
    {key:'jasper',     name:'嘉用',   color:'#af52de'},
    {key:'usable',     name:'可用',   color:'#34c759'}
  ];

  const $ = (q,s=document)=>s.querySelector(q);
  const $$=(q,s=document)=>Array.from(s.querySelectorAll(q));

  function readCats(){
    try{
      const v = JSON.parse(localStorage.getItem(LS_KEY));
      if (Array.isArray(v) && v.length) return v;
    }catch{}
    // try read from DOM
    const domCats = [];
    $$('#catList .rgbaChip').forEach(chip=>{
      const name = (chip.textContent||'').trim();
      const color = (chip.querySelector('.colorDot')||chip).style.background || '#cccccc';
      if (name) domCats.push({key:slugify(name), name, color});
    });
    if (domCats.length){ localStorage.setItem(LS_KEY, JSON.stringify(domCats)); return domCats; }
    localStorage.setItem(LS_KEY, JSON.stringify(DEFAULT_CATS));
    return DEFAULT_CATS.slice();
  }
  function saveCats(a){ localStorage.setItem(LS_KEY, JSON.stringify(a)); }
  function slugify(name){
    return (name||'').toString().trim().toLowerCase()
      .replace(/\s+/g,'_').replace(/[^\w\-]+/g,'').slice(0,24) || 'cat';
  }

  function ensureCatOptions(){
    const cats=readCats();
    const opts=['<option value="">（无）</option>'].concat(cats.map(c=>`<option value="${c.key}">${c.name}</option>`)).join('');
    $$('select[data-k="row_color"]').forEach(sel=>{
      const cur=sel.value;
      sel.innerHTML=opts;
      if (cur) sel.value=cur;
    });
  }

  function renderCatList(){
    const box = $('#catList'); if(!box) return;
    box.innerHTML='';
    const cats=readCats();
    cats.forEach((c,idx)=>{
      const row=document.createElement('div');
      row.className='toolbar';
      row.innerHTML = `
        <span class="rgbaChip">
          <span class="colorDot" style="background:${c.color}"></span>${c.name}
        </span>
        <button class="ghost" data-act="up"   data-i="${idx}">上移</button>
        <button class="ghost" data-act="down" data-i="${idx}">下移</button>
        <button class="ghost" data-act="edit" data-i="${idx}">改名/颜色</button>
        <button class="ghost" data-act="del"  data-i="${idx}">删除</button>
      `;
      box.appendChild(row);
    });
  }

  function bindUI(){
    const nameI = $('#catName');
    const colorI= $('#catColor');
    const colorPreview = $('#catColorPreview') || colorI;
    if (colorI && colorPreview){
      colorI.addEventListener('input', ()=>{ colorPreview.style.background = colorI.value || '#cccccc'; });
    }
    const btnAdd = $('#btnCatAdd');
    if (btnAdd && !btnAdd.__wired){
      btnAdd.__wired = true;
      const confirmAdd = ()=>{
        const name = (nameI && nameI.value||'').trim();
        const color= (colorI && colorI.value)||'#cccccc';
        if (!name){ if(nameI) nameI.focus(); return; }
        const cats=readCats();
        let base=slugify(name), key=base, n=1;
        while (cats.some(x=>x.key===key)) key = base+'_'+(++n);
        cats.push({key, name, color}); saveCats(cats);
        if (nameI) nameI.value='';
        renderCatList(); ensureCatOptions();
      };
      btnAdd.addEventListener('click', confirmAdd);
      if (nameI){
        nameI.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); confirmAdd(); } });
      }
    }
    const list = $('#catList');
    if (list && !list.__wired){
      list.__wired = true;
      list.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-act]'); if(!btn) return;
        const i = parseInt(btn.dataset.i,10); const act=btn.dataset.act;
        const cats=readCats(); if(isNaN(i)||i<0||i>=cats.length) return;
        if (act==='up' && i>0){ [cats[i-1], cats[i]]=[cats[i], cats[i-1]]; saveCats(cats); renderCatList(); ensureCatOptions(); return; }
        if (act==='down' && i<cats.length-1){ [cats[i+1], cats[i]]=[cats[i], cats[i+1]]; saveCats(cats); renderCatList(); ensureCatOptions(); return; }
        if (act==='edit'){
          const nn = prompt('分类名称', cats[i].name);
          if (nn!==null){
            cats[i].name = (nn||'').trim() || cats[i].name;
            const cc = prompt('颜色（十六进制，如 #ff6699）', cats[i].color);
            if (cc) cats[i].color = cc;
            saveCats(cats); renderCatList(); ensureCatOptions();
          }
          return;
        }
        if (act==='del'){
          if (confirm(`删除分类：${cats[i].name}？`)){
            const delKey=cats[i].key; cats.splice(i,1); saveCats(cats);
            // 清理已选该分类的行
            $$('select[data-k="row_color"]').forEach(sel=>{ if (sel.value===delKey) sel.value=''; });
            renderCatList(); ensureCatOptions();
          }
          return;
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{ renderCatList(); ensureCatOptions(); bindUI(); });
  // 若页面有重新渲染的逻辑，定时确保绑定仍在
  setInterval(()=>{ bindUI(); }, 1500);
})();
</script>


<div id="x_gate_overlay" aria-hidden="false">
  <div id="x_gate_box" role="dialog" aria-modal="true" aria-labelledby="x_gate_title">
    <h2 id="x_gate_title">请输入访问密码</h2>
    <p>验证后本设备加入白名单（localStorage），以后免输入。</p>
    <input id="x_gate_input" autocomplete="off" type="password" placeholder="输入密码">
    <div class="row">
      <button id="x_gate_ok">验证并进入</button>
      <button id="x_gate_clear" class="btn-ghost">清除白名单</button>
    </div>
    <div id="x_gate_msg" role="status" aria-live="polite"></div>
  </div>
</div>

<script>
(function(){
  const WH_KEY = 'xhs_whitelist_v1';
  // SHA-256(hex) of your password: jiajia11jiajia22jiajia33
  const PASSWORD_SHA256_HEX = '5bcbba0a49881aa3b1147bd26a19c94a71fde15a844c942515b107b399d6a4db';

  // If already whitelisted, remove overlay as early as possible
  if (localStorage.getItem(WH_KEY) === '1'){
    const ex = document.getElementById('x_gate_overlay');
    if (ex) ex.parentNode.removeChild(ex);
  } else {
    // Defer attaching events until DOM is ready
    document.addEventListener('DOMContentLoaded', wireGate, {once:true});
    // also try immediate wire, in case we're appended at the end
    wireGate();
  }

  function wireGate(){
    const overlay = document.getElementById('x_gate_overlay');
    if (!overlay) return;
    const input = document.getElementById('x_gate_input');
    const okBtn = document.getElementById('x_gate_ok');
    const clrBtn = document.getElementById('x_gate_clear');
    const msg = document.getElementById('x_gate_msg');

    function buf2hex(buffer){
      const bytes = new Uint8Array(buffer);
      return Array.prototype.map.call(bytes, x => ('00' + x.toString(16)).slice(-2)).join('');
    }
    async function sha256hex(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return buf2hex(hash);
    }
    function unlock(){
      // remove overlay without touching page layout/styles
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
      if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
    }

    // focus input
    try{ input && input.focus(); }catch{}

    if (okBtn && !okBtn.__wired){
      okBtn.__wired = true;
      okBtn.addEventListener('click', async ()=>{
        msg.textContent='';
        const v = (input && input.value || '').trim();
        if (!v){ msg.textContent='请输入密码'; return; }
        try{
          const hv = await sha256hex(v);
          if (hv === PASSWORD_SHA256_HEX){
            localStorage.setItem(WH_KEY, '1'); window.dispatchEvent(new CustomEvent('xgate:unlocked'));
            msg.style.color = '#14a85b';
            msg.textContent = '验证通过';
            setTimeout(unlock, 200);
          } else {
            msg.style.color = '#b22222';
            msg.textContent = '密码错误';
            if (input){ input.value=''; input.focus(); }
          }
        }catch(e){
          console.error(e);
          msg.style.color = '#b22222';
          msg.textContent = '验证异常';
        }
      });
    }

    if (input && !input.__wired){
      input.__wired = true;
      input.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){ e.preventDefault(); okBtn && okBtn.click(); }
      });
    }

    if (clrBtn && !clrBtn.__wired){
      clrBtn.__wired = true;
      clrBtn.addEventListener('click', ()=>{
        if (confirm('清除本设备白名单并返回密码页？')){
          localStorage.removeItem(WH_KEY);
          if (input){ input.value=''; input.focus(); }
          msg.textContent='已清除';
          msg.style.color='#444';
        }
      });
    }
  }
})();
</script>


<script>
(function(){
  const WH_KEY = 'xhs_whitelist_v1';

  function findBadgeContainer(){
    // Prefer the right-side header container used in your layout
    var container = document.querySelector('.wrap > div:first-child > div:last-child');
    return container || document.body;
  }

  function replaceGiteeWithStatus(){
    var container = findBadgeContainer();
    if (!container) return null;
    // Find any Gitee badge/link
    var gitee = container.querySelector('a.badge, a[href*="gitee.com"]');
    var statusEl = container.querySelector('#verifyStatus');
    if (!statusEl){
      statusEl = document.createElement('span');
      statusEl.id = 'verifyStatus';
      statusEl.className = (gitee && gitee.className) ? gitee.className : 'badge';
      // If there is a Gitee link, replace it; otherwise append to container
      if (gitee && gitee.parentNode){
        gitee.parentNode.replaceChild(statusEl, gitee);
      }else{
        container.appendChild(statusEl);
      }
    }else if (gitee && gitee.parentNode){
      // If both exist, remove gitee
      gitee.parentNode.removeChild(gitee);
    }
    return statusEl;
  }

  function refreshStatus(){
    var statusEl = replaceGiteeWithStatus();
    if (!statusEl) return;
    var verified = (localStorage.getItem(WH_KEY) === '1');
    statusEl.textContent = verified ? '已验证白名单' : '未验证';
  }

  // Init once DOM is ready
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', refreshStatus, {once:true});
  } else {
    refreshStatus();
  }

  // Update when unlocked
  window.addEventListener('xgate:unlocked', refreshStatus);
})();
</script>

</body>
</html>
