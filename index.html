<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>小红书手机号整理 · 协作表格（苹果风 v6）</title>
<link rel="apple-touch-icon" href="./icon-192-jia-rounded-fix.png">
<link rel="manifest" href="./manifest.json">
<style>
:root{--bg:#ffffff;--fg:#111827;--muted:#6b7280;--brand:#3b82f6;--ok:#10b981;--danger:#ef4444;--chip:#f3f4f6;--chip-border:#e5e7eb;--radius:14px;--shadow:0 8px 30px rgba(0,0,0,.06);--table-font:15px;--row-h:44px}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:14px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,Helvetica,Arial,sans-serif}
.container{max-width:1200px;margin:22px auto;padding:0 16px}
.hstack{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:.5ch;height:34px;padding:0 16px;border-radius:999px;background:#f7f7f8;border:1px solid #ececee;color:#6b7280}
.badge .dot{width:10px;height:10px;border-radius:50%}
.btn{height:42px;display:inline-flex;align-items:center;gap:10px;padding:0 18px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.02);cursor:pointer;user-select:none}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.ghost{background:#f7f7f8}
.btn.danger{border-color:transparent;background:#fee2e2;color:#b91c1c}
.btn:active{transform:translateY(1px)}
.toolbar{position:sticky;top:0;background:var(--bg);z-index:5;padding:10px 0 14px}
.status{margin-left:auto}
.table-wrap{overflow:auto;border:1px solid #ececee;border-radius:16px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:var(--table-font)}
thead th{position:sticky;top:0;background:#fafafa;border-bottom:1px solid #ececee;text-align:left;padding:10px 12px;font-weight:600;white-space:nowrap}
tbody td{border-bottom:1px solid #f1f3f5;padding:8px 10px;white-space:nowrap}
tbody tr:nth-child(even){background:#fcfcfd}
input.cell, textarea.cell{width:100%;height:var(--row-h);padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
td:nth-child(5) .cell{transition:background-color .2s ease}
.cat-panel{border:1px solid #ececee;border-radius:16px;padding:12px;margin-top:16px}
.cat-row{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:10px}
.cat-name{background:var(--chip);border:1px solid var(--chip-border);padding:6px 10px;border-radius:999px;white-space:nowrap;max-width:28ch;overflow:hidden;text-overflow:ellipsis}
.cat-actions{margin-left:20ch;display:flex;gap:8px;flex-wrap:wrap}
.cat-actions .mini{height:30px;padding:0 10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff}
.cat-actions .mini.danger{background:#fee2e2;color:#b91c1c;border-color:#fecaca}
.cat-actions .mini.color{background:#f0f9ff;color:#0369a1;border-color:#bae6fd}
.menu{position:relative;display:inline-block}
.menu .list{display:none;position:absolute;inset:auto auto auto 0;z-index:20;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:var(--shadow);overflow:hidden;min-width:190px}
.menu.open .list{display:block}
.menu .item{padding:10px 14px;cursor:pointer}
.menu .item:hover{background:#f7f7f8}
.dialog-mask{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;z-index:50}
.dialog{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,520px);background:#fff;border-radius:16px;box-shadow:var(--shadow);display:none;z-index:60}
.dialog header{font-weight:700;padding:14px 18px;border-bottom:1px solid #ececee}
.dialog .content{padding:16px}
.dialog .actions{display:flex;justify-content:flex-end;gap:10px;padding:0 16px 16px}
.dialog.show,.dialog-mask.show{display:block}
@media (max-width:768px){
  :root{--table-font:14px;--row-h:42px}
  .status{margin-left:0}
  thead th, tbody td{padding:8px}
  .cat-actions{margin-left:16ch}
}
</style>
</head>
<body>
<div class="container">
  <div class="toolbar hstack">
    <div id="whitelistTag" class="badge"><span>未验证</span></div>
    <div class="badge" id="cloudTag"><span class="dot" id="cloudDot" style="background:#ef4444"></span><span id="cloudText">云端未连接</span></div>

    <div class="menu">
      <button class="btn primary" id="btnAddRow">+ 新增一行</button>
      <div class="list" id="addRowMenu">
        <div class="item" data-pos="top">在最上方新增一行</div>
        <div class="item" data-pos="middle">在中间新增一行（在当前页中位）</div>
        <div class="item" data-pos="bottom">在最下方新增一行</div>
      </div>
    </div>

    <button class="btn" id="btnImport">导入 CSV</button>
    <button class="btn ghost" id="btnDisplay">显示与尺寸</button>
    <button class="btn" id="btnSaveCloud">保存到云端</button>
    <button class="btn" id="btnLoadCloud">从云端加载</button>
    <button class="btn" id="btnExport">导出 CSV</button>
    <button class="btn danger" id="btnClear">清空全部</button>
    <div class="status hstack">
      <div class="badge">本地模式：不联网 · 支持 CSV 导入 / JSON 导出</div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="sheet">
      <thead>
        <tr>
          <th style="min-width:130px">电话号码</th>
          <th style="min-width:90px">所属人</th>
          <th style="min-width:100px">微信实名人</th>
          <th style="min-width:120px">对应微信名</th>
          <th style="min-width:220px">小红书名称</th>
          <th style="min-width:180px">备注</th>
          <th style="min-width:120px">分类</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>

  <div class="hstack" style="margin-top:14px">
    <div class="btn ghost" id="btnCatPanel">分类设置</div>
    <div class="hstack">
      <input id="newCatName" placeholder="新增分类名称（<=8字）" class="cell" style="height:38px;width:240px">
      <input type="color" id="newCatColor" value="#10b981" style="height:38px;width:48px;border:none;background:transparent">
      <button class="btn" id="btnAddCat">新增分类</button>
    </div>
  </div>

  <div class="cat-panel" id="catPanel" style="display:none"></div>

  <div class="dialog-mask" id="mask"></div>
  <div class="dialog" id="dlgDisplay">
    <header>显示与尺寸</header>
    <div class="content">
      <div class="hstack" style="justify-content:space-between">
        <label>表格字体(px)：<input type="range" id="fontRange" min="12" max="18" step="1" value="15"></label>
        <label>行高(px)：<input type="range" id="rowRange" min="36" max="54" step="2" value="44"></label>
      </div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="dlgCancel">取消</button>
      <button class="btn primary" id="dlgOk">确定</button>
    </div>
  </div>
</div>

<script>
const WORKER_URL = 'https://xhsphone.sevenoy.workers.dev';
const ACCESS_KEY  = localStorage.getItem('ACCESS_KEY') || '';

let state = { rows:[], cats:[], view:{font:15,row:44}, ver:1, updated_at:'' };

const $ = s => document.querySelector(s);
const bodyEl = $('#body');
const catPanel = $('#catPanel');

function toast(msg){ alert(msg); }

function loadLocal(){
  const j = localStorage.getItem('xhs_rows_v6'); if(j){ try{ state = JSON.parse(j);}catch{} }
  applyView(); renderAll();
}
function saveLocal(){ state.updated_at = new Date().toISOString(); localStorage.setItem('xhs_rows_v6', JSON.stringify(state)); }

function applyView(){
  document.documentElement.style.setProperty('--table-font', state.view.font + 'px');
  document.documentElement.style.setProperty('--row-h', state.view.row + 'px');
  $('#fontRange').value = state.view.font; $('#rowRange').value = state.view.row;
}

function renderAll(){
  bodyEl.innerHTML = '';
  state.rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = ['phone','owner','wx_real','wx_name','xhs_name','note','cat'].map((k)=>{
      return \`<td><input class="cell" data-idx="\${i}" data-key="\${k}" value="\${escapeHtml(r[k]??'')}"></td>\`;
    }).join('');
    bodyEl.appendChild(tr);
  });
  renderCats();
  paintXhsBg();
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function hexToRgba(hex, a){ hex=hex.replace('#',''); if(hex.length===3) hex=hex.split('').map(x=>x+x).join(''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return \`rgba(\${r},\${g},\${b},\${a})\`; }

function paintXhsBg(){
  const catMap = Object.fromEntries(state.cats.map(c=>[c.name,c.color]));
  [...bodyEl.querySelectorAll('tr')].forEach((tr,i)=>{
    const cat = state.rows[i]?.cat || '';
    const color = catMap[cat];
    const cell = tr.children[4]?.querySelector('input.cell');
    if(cell){ cell.style.backgroundColor = color ? hexToRgba(color, .18) : '#fff'; }
  });
}

bodyEl.addEventListener('input', e=>{
  const el = e.target; if(!el.classList.contains('cell')) return;
  const i = +el.dataset.idx, k = el.dataset.key;
  if(!state.rows[i]) return;
  state.rows[i][k] = el.value;
  if(k==='cat') paintXhsBg();
  saveLocal();
});

const menu = $('#addRowMenu');
$('#btnAddRow').addEventListener('click', ()=> menu.parentElement.classList.toggle('open'));
menu.addEventListener('click', e=>{
  const item = e.target.closest('.item'); if(!item) return;
  const pos = item.dataset.pos;
  let insertAt = state.rows.length;
  if(pos==='top') insertAt = 0;
  if(pos==='middle') insertAt = Math.floor(state.rows.length/2);
  state.rows.splice(insertAt, 0, {phone:'',owner:'',wx_real:'',wx_name:'',xhs_name:'',note:'',cat:''});
  saveLocal(); renderAll(); menu.parentElement.classList.remove('open');
});
document.addEventListener('click', e=>{ if(!e.target.closest('.menu')) menu.parentElement?.classList.remove('open'); });

$('#btnExport').addEventListener('click', ()=>{
  const csv = toCSV(state.rows); download('xhs_rows.csv', csv);
});
$('#btnImport').addEventListener('click', async ()=>{
  const file = await pickFile('.csv,text/csv'); if(!file) return;
  const text = await file.text();
  try{ const rows = fromCSV(text); state.rows = rows; saveLocal(); renderAll(); toast('已导入 CSV'); }
  catch(err){ toast('CSV 解析失败'); }
});
$('#btnClear').addEventListener('click', ()=>{
  if(confirm('确定要清空全部数据？')){ state.rows = []; saveLocal(); renderAll(); }
});

$('#btnCatPanel').addEventListener('click', ()=>{
  catPanel.style.display = catPanel.style.display==='none'?'block':'none';
});
$('#btnAddCat').addEventListener('click', ()=>{
  const name = $('#newCatName').value.trim();
  const color = $('#newCatColor').value;
  if(!name) return toast('请输入分类名称');
  if(state.cats.find(c=>c.name===name)) return toast('已存在同名分类');
  state.cats.push({name, color});
  $('#newCatName').value='';
  saveLocal(); renderCats(); paintXhsBg();
});
function renderCats(){
  catPanel.innerHTML='';
  state.cats.forEach((c,i)=>{
    const row = document.createElement('div');
    row.className='cat-row';
    row.innerHTML = \`
      <div class="cat-name" style="border-color:\${c.color}33;background:\${hexToRgba(c.color,.08)}">\${escapeHtml(c.name)}</div>
      <div class="cat-actions">
        <button class="mini" data-act="up" data-i="\${i}">上移</button>
        <button class="mini" data-act="down" data-i="\${i}">下移</button>
        <button class="mini" data-act="rename" data-i="\${i}">改名</button>
        <button class="mini color" data-act="recolor" data-i="\${i}">改颜色</button>
        <button class="mini danger" data-act="remove" data-i="\${i}">删除</button>
      </div>\`;
    catPanel.appendChild(row);
  });
}
catPanel.addEventListener('click', e=>{
  const btn = e.target.closest('button.mini'); if(!btn) return;
  const i = +btn.dataset.i; const act = btn.dataset.act;
  if(act==='up' && i>0){ [state.cats[i-1],state.cats[i]]=[state.cats[i],state.cats[i-1]]; }
  if(act==='down' && i<state.cats.length-1){ [state.cats[i+1],state.cats[i]]=[state.cats[i],state.cats[i+1]]; }
  if(act==='rename'){ const nv = prompt('新的分类名称', state.cats[i].name);
    if(nv && !state.cats.find((c,idx)=>c.name===nv && idx!==i)){ const ov=state.cats[i].name; state.cats[i].name=nv; state.rows.forEach(r=>{ if(r.cat===ov) r.cat=nv; }); } }
  if(act==='recolor'){ const nv = prompt('新的颜色（#RRGGBB）', state.cats[i].color); if(/^#([0-9A-Fa-f]{6})$/.test(nv||'')) state.cats[i].color=nv; }
  if(act==='remove'){ if(!confirm('删除该分类？不会删除行，仅移除分类定义')) return; const name=state.cats[i].name; state.cats.splice(i,1); state.rows.forEach(r=>{ if(r.cat===name) r.cat=''; }); }
  saveLocal(); renderCats(); paintXhsBg();
});

$('#btnDisplay').addEventListener('click', ()=>openDisplay(true));
$('#dlgCancel').addEventListener('click', ()=>openDisplay(false));
$('#dlgOk').addEventListener('click', ()=>{
  state.view.font = +$('#fontRange').value;
  state.view.row = +$('#rowRange').value;
  applyView(); saveLocal(); openDisplay(false);
});
function openDisplay(show){ $('#mask').classList.toggle('show', show); $('#dlgDisplay').classList.toggle('show', show); }

async function pingCloud(){
  try{
    const rsp = await fetch(WORKER_URL, { headers: { 'X-Access-Key': getKey(), 'Accept':'application/json' } });
    if(rsp.ok){ $('#cloudDot').style.background = '#10b981'; $('#cloudText').textContent = '云端已连接'; return true; }
  }catch(_){}
  $('#cloudDot').style.background = '#ef4444'; $('#cloudText').textContent = '云端未连接'; return false;
}
function getKey(){ let k = localStorage.getItem('ACCESS_KEY'); if(!k){ k = prompt('输入云端访问密钥（ACCESS_KEY）'); if(k){ localStorage.setItem('ACCESS_KEY', k);} } return k||''; }
$('#btnLoadCloud').addEventListener('click', async ()=>{
  const ok = await pingCloud(); if(!ok) return toast('云端未连接');
  try{
    const r = await fetch(WORKER_URL,{ method:'GET', headers:{'X-Access-Key': getKey(), 'Accept':'application/json'} });
    const j = await r.json();
    if(j && j.rows){ state.rows=j.rows||[]; state.cats=j.cats||[]; state.view=j.view||state.view; saveLocal(); applyView(); renderAll(); toast('已从云端读取'); }
    else toast('云端数据为空');
  }catch(e){ toast('读取失败'); }
});
$('#btnSaveCloud').addEventListener('click', async ()=>{
  const ok = await pingCloud(); if(!ok) return toast('云端未连接');
  try{
    const r = await fetch(WORKER_URL,{ method:'PUT', headers:{'Content-Type':'application/json','X-Access-Key': getKey()}, body: JSON.stringify(state) });
    if(r.ok) toast('已保存到云端'); else toast('云端保存失败（网络或权限）');
  }catch(e){ toast('云端保存失败（网络或权限）'); }
});

function toCSV(rows){
  const header = ['电话号码','所属人','微信实名人','对应微信名','小红书名称','备注','分类'];
  const keys   = ['phone','owner','wx_real','wx_name','xhs_name','note','cat'];
  const esc = s => ('"'+String(s??'').replace(/"/g,'""')+'"');
  const lines = [header.join(',')];
  for(const r of rows) lines.push(keys.map(k=>esc(r[k]??'')).join(','));
  return lines.join('\n');
}
function fromCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean); const header = lines.shift(); const cols = header.split(',');
  const idx = { phone: cols.indexOf('电话号码'), owner: cols.indexOf('所属人'), wx_real: cols.indexOf('微信实名人'), wx_name: cols.indexOf('对应微信名'), xhs_name: cols.indexOf('小红书名称'), note: cols.indexOf('备注'), cat: cols.indexOf('分类') };
  return lines.map(line=>{ const cells = parseCSVLine(line); return { phone: cells[idx.phone]||'', owner: cells[idx.owner]||'', wx_real: cells[idx.wx_real]||'', wx_name: cells[idx.wx_name]||'', xhs_name: cells[idx.xhs_name]||'', note: cells[idx.note]||'', cat: cells[idx.cat]||'', }; });
}
function parseCSVLine(line){ const out=[], re=/(?:^|,)(?:"((?:[^"]|"")*)"|([^",]*))/g; let m; while((m=re.exec(line))!==null){ out.push( (m[1]||m[2]||'').replace(/""/g,'"') ); } return out; }
function download(name,text){ const url=URL.createObjectURL(new Blob([text],{type:'text/plain;charset=utf-8'})); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }
function pickFile(accept){ return new Promise(res=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept=accept; inp.onchange=()=>res(inp.files[0]||null); inp.click(); }); }

(function verify(){ if(localStorage.getItem('whitelist_ok')){ $('#whitelistTag').innerHTML='已验证白名单'; } else { $('#whitelistTag').innerHTML='未验证'; } })();

loadLocal(); pingCloud();
</script>
</body></html>
