<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
<title>小红书手机号整理 · 协作表格（v7 云端同步 + 移动优化）</title>
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<style>
:root {
  --bg:#fff;--fg:#111418;--muted:#6e6e73;--line:#e5e5ea;--blue:#007aff;
  --cell:#fff;--cell-alt:#f5f5f7;--zebra:#eef5ff;--pad:6px;--colScale:1;
}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC",sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:12px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
button,input,select{height:32px;border-radius:10px;border:1px solid var(--line);padding:0 10px;font:inherit}
button{background:var(--blue);color:#fff;cursor:pointer}
button.ghost{background:#f2f2f7;color:#000}
.panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px;margin-bottom:12px}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
th,td{padding:var(--pad) 8px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
th{background:#fafafa;position:sticky;top:0;z-index:2}
.zebra tr:nth-child(even){background:var(--zebra)}
td[contenteditable="true"]:focus{background:var(--cell-alt);outline:1px solid var(--line)}
@media(max-width:640px){button{font-size:13px;height:30px;padding:0 8px}th,td{font-size:13px}}
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <h1>小红书手机号整理 · v7</h1>
    <span id="cloudStatus" class="badge"><i id="cloudDot" style="width:8px;height:8px;border-radius:50%;background:#aaa;display:inline-block;margin-right:6px"></i><span id="cloudText">离线</span></span>
  </div>

  <div class="panel toolbar">
    <button id="btnAdd">＋新增一行</button>
    <label><input type="file" id="csvFile" accept=".csv" hidden>导入CSV</label>
    <button id="btnExport" class="ghost">导出CSV</button>
    <button id="btnSaveCloud" class="ghost">保存到云端</button>
    <button id="btnLoadCloud" class="ghost">从云端加载</button>
    <button id="btnCats" class="ghost">分类设置</button>
  </div>

  <div class="panel table-wrap">
    <table id="tbl" class="zebra">
      <thead><tr>
        <th>电话号码</th><th>所属人</th><th>微信实名人</th><th>对应微信名</th>
        <th>小红书名称</th><th>备注</th><th>分类</th><th>操作</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const WORKER_URL = 'https://xhsphone.sevenoy.workers.dev';
const ACCESS_KEY = 'xhs_ZO6dI5#yXGgLkubH_rzMZC@wyY%h6J-kc7XN4E^O';

const LS_ROWS='xhs_rows_v7', LS_CATS='xhs_cats_v7';

function getRows(){try{return JSON.parse(localStorage.getItem(LS_ROWS)||'[]')}catch{return []}}
function setRows(v){localStorage.setItem(LS_ROWS,JSON.stringify(v));render()}
function getCats(){try{return JSON.parse(localStorage.getItem(LS_CATS)||'[]')}catch{return []}}
function setCats(v){localStorage.setItem(LS_CATS,JSON.stringify(v));render()}

function render(){
  const rows=getRows(),cats=getCats();
  const tb=document.getElementById('tbody');tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const cat=cats.find(c=>c.name===r.cat);
    const bg=cat?`background:${cat.color}30;`:'';
    tr.innerHTML=`
      <td contenteditable data-k="phone">${r.phone||''}</td>
      <td contenteditable data-k="owner">${r.owner||''}</td>
      <td contenteditable data-k="wx_real">${r.wx_real||''}</td>
      <td contenteditable data-k="wx_name">${r.wx_name||''}</td>
      <td contenteditable data-k="xhs_name" style="${bg}">${r.xhs_name||''}</td>
      <td contenteditable data-k="note">${r.note||''}</td>
      <td><select data-k="cat">${['<option value="">（无）</option>',...cats.map(c=>`<option ${c.name===r.cat?'selected':''}>${c.name}</option>`)].join('')}</select></td>
      <td><button data-act="del">删除</button></td>`;
    tb.appendChild(tr);
  });
}

document.getElementById('tbody').addEventListener('input',e=>{
  const td=e.target.closest('td[contenteditable]');if(!td)return;
  const tr=td.parentElement;const i=[...tr.parentElement.children].indexOf(tr);
  const k=td.dataset.k;const rows=getRows();rows[i][k]=td.textContent.trim();setRows(rows);
});

document.getElementById('tbody').addEventListener('change',e=>{
  if(e.target.tagName==='SELECT'){
    const tr=e.target.closest('tr');const i=[...tr.parentElement.children].indexOf(tr);
    const rows=getRows();rows[i].cat=e.target.value;setRows(rows);
  }
  if(e.target.dataset.act==='del'){
    const tr=e.target.closest('tr');const i=[...tr.parentElement.children].indexOf(tr);
    const rows=getRows();rows.splice(i,1);setRows(rows);
  }
});

document.getElementById('btnAdd').onclick=()=>{const rows=getRows();rows.unshift({phone:'',owner:'',wx_real:'',wx_name:'',xhs_name:'',note:'',cat:''});setRows(rows)};

// CSV
function toCSV(rows){const head=['电话号码','所属人','微信实名人','对应微信名','小红书名称','备注','分类'];const lines=[head.join(',')];rows.forEach(r=>{lines.push([r.phone,r.owner,r.wx_real,r.wx_name,r.xhs_name,r.note,r.cat].map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(','))});return lines.join('\n');}
function fromCSV(txt){const lines=txt.split(/\r?\n/).filter(Boolean),out=[];for(let i=1;i<lines.length;i++){const c=lines[i].split(',').map(s=>s.replace(/^"|"$/g,''));out.push({phone:c[0],owner:c[1],wx_real:c[2],wx_name:c[3],xhs_name:c[4],note:c[5],cat:c[6]});}return out;}
document.getElementById('csvFile').addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;const txt=await f.text();setRows(fromCSV(txt));alert('已导入CSV')});
document.getElementById('btnExport').onclick=()=>{const blob=new Blob([toCSV(getRows())],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='xhs.csv';a.click()};

// 云端同步
async function saveToCloud(){try{const res=await fetch(WORKER_URL,{method:'PUT',headers:{'Content-Type':'application/json','X-Access-Key':ACCESS_KEY},body:JSON.stringify({rows:getRows(),cats:getCats(),updated_at:new Date().toISOString()})});if(!res.ok)throw 0;alert('已保存云端');}catch(e){alert('保存失败')}}
async function loadFromCloud(){try{const r=await fetch(WORKER_URL,{headers:{'X-Access-Key':ACCESS_KEY}});if(!r.ok)throw 0;const d=await r.json();localStorage.setItem(LS_ROWS,JSON.stringify(d.rows||[]));localStorage.setItem(LS_CATS,JSON.stringify(d.cats||[]));render();alert('已从云端加载')}catch(e){alert('加载失败')}}

document.getElementById('btnSaveCloud').onclick=saveToCloud;
document.getElementById('btnLoadCloud').onclick=loadFromCloud;

document.getElementById('btnCats').onclick=()=>{const name=prompt('分类名');if(!name)return;const color=prompt('颜色(十六进制)', '#a0c4ff');const cats=getCats();cats.push({name,color});setCats(cats);alert('已添加分类')};

render();
</script>
</body>
</html>
