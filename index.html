<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
<title>XHSPHONE</title>

<!-- ✅ iOS 专用图标（添加到主屏幕） -->
<link rel="apple-touch-icon" sizes="180x180" href="/main/icon-192.png?v=20251016">
<link rel="apple-touch-icon" href="/main/icon-192.png?v=20251016">

<!-- ✅ Android / 桌面 favicon -->
<link rel="icon" type="image/png" sizes="192x192" href="/main/icon-192.png?v=20251016">

<!-- ✅ 启用 PWA & iOS 全屏 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="XHSPHONE">
<meta name="theme-color" content="#ffffff">

<style>
:root{
  --bg:#fff;--fg:#111418;--muted:#6e6e73;--line:#e5e5ea;--blue:#007aff;--blue-press:#0063cc;
  --cell:#fff;--cell-alt:#f5f5f7;
  --pad:6px;--colScale:1;--zebra:#eef5ff;
  --w-phone:160px;--w-owner:120px;--w-real:120px;--w-wx:160px;--w-xhs:340px;--w-note:220px;--w-cat:140px;
  --w-actions:220px;      /* 扩宽避免遮挡分类下拉 */
  --active:#3478F7;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Helvetica Neue",Helvetica,Arial,"PingFang SC","Noto Sans CJK SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:12px}
h1{font-size:18px;font-weight:700;margin:0 0 8px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
input,select,button{height:32px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#111;padding:0 10px}
input[type=file]{display:none}
button{background:var(--blue);border:none;color:#fff;padding:0 12px;cursor:pointer;transition:background .15s}
button.ghost{background:#f2f2f7;color:#000;border:1px solid var(--line)}
button:active{background:var(--blue-press)}
button.ghost.active{background:var(--active);color:#fff;border-color:var(--active)}
.badge{font-variant-numeric:tabular-nums;border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted)}
.panel{background:var(--cell);border:1px solid var(--line);border-radius:14px;padding:10px;margin:10px 0}
table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
th,td{padding:var(--pad) 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
thead th{position:sticky;top:0;background:#f9f9fb;font-weight:600;z-index:2}
tbody.zebra tr:nth-child(even) td{ background: var(--zebra); }
td[contenteditable='true']{background:transparent; outline:none}
td[contenteditable='true']:focus{background:var(--cell-alt); outline:1px solid var(--line)}
.status{font-size:12px;color:var(--muted);margin-top:6px;white-space:pre-wrap}
.rgbaChip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;height:32px}
.colorDot{width:14px;height:14px;border-radius:4px;border:1px solid #c9c9ce;display:inline-block}
th.col-phone, td.col-phone{ width: calc(var(--w-phone) * var(--colScale)); }
th.col-owner, td.col-owner{ width: calc(var(--w-owner) * var(--colScale)); }
th.col-real,  td.col-real{  width: calc(var(--w-real)  * var(--colScale)); }
th.col-wx,    td.col-wx{    width: calc(var(--w-wx)    * var(--colScale)); }
th.col-xhs,   td.col-xhs{   width: calc(var(--w-xhs)   * var(--colScale)); }
th.col-note,  td.col-note{  width: calc(var(--w-note)  * var(--colScale)); }
th.col-cat,   td.col-cat{   width: calc(var(--w-cat)   * var(--colScale)); }
th.col-act,   td.col-act{   width: calc(var(--w-actions)* var(--colScale)); }
td.col-act{ position:relative; overflow:visible; }

/* 操作条：默认隐藏；行处于编辑态才显示 */
.edit-bar{
  display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%);
  gap:6px; background:#f2f2f7; border-radius:12px; padding:6px;
  box-shadow:0 6px 14px rgba(0,0,0,.08); z-index:20;
}
.row-editing .edit-bar{ display:flex; }

/* 分类面板：Grid 对齐按钮 */
.cat-row{
  display:grid; grid-template-columns:auto 1fr repeat(5,max-content);
  align-items:center; column-gap:12px; row-gap:10px;
}
.cat-row .namePill{
  display:inline-flex;align-items:center;gap:8px;
  border:1px solid var(--line);border-radius:12px;padding:6px 10px;background:#fff
}
.cat-row .spacer{height:1px}

/* 顶部状态徽章 */
#verifyStatus.badge, #cloudStatus{
  display:inline-flex; align-items:center; height:28px; line-height:28px;
  padding:0 12px; border-radius:999px; white-space:nowrap; vertical-align:middle;
}
#cloudStatus #cloudDot{ width:8px; height:8px; border-radius:50%; margin-right:6px; background:#aaa; }
@media (max-width:420px){
  #verifyStatus.badge, #cloudStatus{ height:26px; line-height:26px; padding:0 10px; font-size:12px; }
}
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
</style>
</head>


<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><h1>XHSPHONE</h1></div>
    <div><span id="verifyStatus" class="badge">未验证</span> <span id="cloudStatus" class="badge"><i id="cloudDot"></i><span id="cloudText">离线</span></span></div>
  </div>

  <div class="panel">
    <div class="toolbar">
      <input id="q" placeholder="搜索：任意关键词" style="flex:1 1 280px" />
      <select id="filterOwner"><option value="all">所属人：全部</option></select>
      <select id="filterWxReal"><option value="all">微信实名人：全部</option></select>
      <select id="sortBy">
        <option value="order">排序：手动</option>
        <option value="owner">排序：所属人</option>
        <option value="wx_real">排序：微信实名人</option>
        <option value="phone">排序：电话号码</option>
        <option value="xhs_name">排序：小红书名称</option>
        <option value="row_color">排序：分类</option>
      </select>

      <!-- 顶部按钮：统一四字；导出JSON隐藏但保留 -->
      <button id="btnAdd">新增一行</button>
      <button id="btnImportCSV">导入数据</button>
      <button id="btnSaveCloud" class="ghost">保存云端</button>
      <button id="btnLoadCloud" class="ghost">云端加载</button>
      <button id="btnExportCSV" class="ghost">导出数据</button>
      <input id="csvFile" type="file" accept=".csv,text/csv" />
      <button id="btnExport" class="ghost" style="display:none">导出JSON</button>
      <button id="btnClearAll" class="ghost">清空全部</button>
      <button id="btnCategories" class="ghost">分类设置</button>
      <button id="btnView" class="ghost">显示尺寸</button>
      <button id="btnDebug" class="ghost">显示日志</button>
    </div>
    <div class="status" id="statusText">本地模式：不联网 · 支持 CSV 导入 / JSON 导出</div>
  </div>

  <div class="panel" style="overflow:auto;max-height:92vh">
    <div class="table-wrap"><table id="grid">
      <thead>
        <tr>
          <th class="col-phone">电话号码</th>
          <th class="col-owner">所属人</th>
          <th class="col-real">微信实名人</th>
          <th class="col-wx">对应微信名</th>
          <th class="col-xhs">小红书名称</th>
          <th class="col-note">备注</th>
          <th class="col-cat">分类</th>
          <th class="col-act">操作</th>
        </tr>
      </thead>
      <tbody id="gridBody" class="zebra"></tbody>
    </table></div>
  </div>

  <!-- 分类设置 -->
  <div class="panel" id="panelCategories" style="display:none">
    <div class="toolbar" style="align-items:flex-start">
      <div class="rgbaChip">
        <span class="colorDot" id="catColorPreview"></span>
        <input id="catName" placeholder="分类名称，例如：Olina用" style="width:180px">
        <input id="catColor" type="color" value="#007aff" style="width:60px;padding:0 2px">
      </div>
      <button id="btnCatAdd">新增分类</button>
      <div class="status">设置后将改变<b>小红书名称</b>这一格的<strong>背景色</strong>（透明度 0.18）。</div>
    </div>
    <div id="catList"></div>
  </div>

  <!-- 显示与尺寸 -->
  <div class="panel" id="panelView" style="display:none">
    <div class="toolbar">
      <label>行高</label>
      <input id="rowPad" type="range" min="4" max="14" step="1" value="6" style="width:160px">
      <label>列宽缩放</label>
      <input id="colScale" type="range" min="0.7" max="1.4" step="0.05" value="1" style="width:160px">
      <label>隔行着色</label>
      <input id="zebraOn" type="checkbox" checked>
      <input id="zebraColor" type="color" value="#eef5ff">
      <button id="btnCompact" class="ghost">一键紧凑</button>
      <button id="btnResetSize" class="ghost">恢复默认</button>
    </div>
  </div>
</div>

<!-- Dexie -->
<script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>

<script>
(() => {
  /* 配置 */
  const WORKER_URL = 'https://xhsphone.sevenoy.workers.dev';
  const ACCESS_KEY  = 'xhs_ZO6dI5#yXGgLkubH_rzMZC@wyY%h6J-kc7XN4E^O';

  /* 工具 */
  const $  = (q, s=document)=>s.querySelector(q);
  const $$ = (q, s=document)=>Array.from(s.querySelectorAll(q));
  function hexToRgba(hex, a){ hex=(hex||'').replace('#',''); if(hex.length===3) hex=hex.split('').map(x=>x+x).join(''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }

  /* 视图 */
  const readView=()=>{ try{ return JSON.parse(localStorage.getItem('view_v6'))||{} }catch{ return {} } };
  const saveView=(v)=>localStorage.setItem('view_v6', JSON.stringify(v));
  function applyView(v){
    document.documentElement.style.setProperty('--pad', (v.pad??6)+'px');
    document.documentElement.style.setProperty('--colScale', v.colScale??1);
    document.documentElement.style.setProperty('--zebra', v.zebraColor||'#eef5ff');
    const body=$('#gridBody');
    (v.zebraOn===false?body.classList.remove('zebra'):body.classList.add('zebra'));
    $('#rowPad').value = v.pad??6;
    $('#colScale').value = v.colScale??1;
    $('#zebraOn').checked = !(v.zebraOn===false);
    $('#zebraColor').value = v.zebraColor||'#eef5ff';
  }

  /* 分类 */
  const DEFAULT_CATS=[
    {key:'enterprise', name:'企业号', color:'#ffd60a'},
    {key:'olina',      name:'Olina用', color:'#007aff'},
    {key:'jasper',     name:'嘉用',   color:'#af52de'},
    {key:'usable',     name:'可用',   color:'#34c759'}
  ];
  const readCats=()=>{ try{ return JSON.parse(localStorage.getItem('cats_v6'))||DEFAULT_CATS; }catch{ return DEFAULT_CATS; } };
  const saveCats=(c)=>localStorage.setItem('cats_v6', JSON.stringify(c));
  const catColorOf=(key)=>{ const c=readCats().find(x=>x.key===key); return c?c.color:null; };
  const catNameOf =(key)=>{ const c=readCats().find(x=>x.key===key); return c?c.name:''; };

  /* DB */
  const dbLocal=new Dexie('xhs_phone_sheet_v6');
  dbLocal.version(2).stores({ rows:'id, order, phone, owner, wx_real, wx_name, xhs_name, note1, row_color, updated_at' });

  /* 行渲染 */
  function makeRowTr(r){
    const tr=document.createElement('tr'); tr.dataset.id=r.id; tr.dataset.order=r.order||0;
    const bg = r.row_color ? hexToRgba(catColorOf(r.row_color)||'#ffffff', .18) : '';
    tr.innerHTML=`
      <td class="col-phone" contenteditable="true" data-k="phone">${r.phone||''}</td>
      <td class="col-owner" contenteditable="true" data-k="owner">${r.owner||''}</td>
      <td class="col-real"  contenteditable="true" data-k="wx_real">${r.wx_real||''}</td>
      <td class="col-wx"    contenteditable="true" data-k="wx_name">${r.wx_name||''}</td>
      <td class="col-xhs"   contenteditable="true" data-k="xhs_name" style="${bg?`background:${bg};`:''}">${r.xhs_name||''}</td>
      <td class="col-note"  contenteditable="true" data-k="note1">${r.note1||''}</td>
      <td class="col-cat"><select data-k="row_color"></select></td>
      <td class="col-act">
        <button data-act="toggleEdit" class="ghost">编辑</button>
        <div class="edit-bar">
          <button data-act="up" class="ghost">上移</button>
          <button data-act="down" class="ghost">下移</button>
          <button data-act="del" class="ghost">删除</button>
        </div>
      </td>`;
    return tr;
  }

  /* 渲染/过滤/排序 */
  async function refreshFilters(){
    const all=await dbLocal.rows.toArray();
    const owners=[...new Set(all.map(r=>r.owner).filter(Boolean))];
    const reals=[...new Set(all.map(r=>r.wx_real).filter(Boolean))];
    const oSel=$('#filterOwner'); const saveO=oSel.value;
    oSel.innerHTML='<option value="all">所属人：全部</option>'+owners.map(v=>`<option value="${v}">${v}</option>`).join(''); oSel.value=owners.includes(saveO)?saveO:'all';
    const wSel=$('#filterWxReal'); const saveW=wSel.value;
    wSel.innerHTML='<option value="all">微信实名人：全部</option>'+reals.map(v=>`<option value="${v}">${v}</option>`).join(''); wSel.value=reals.includes(saveW)?saveW:'all';
  }
  async function ensureCatOptions(){
    const cats=readCats();
    const opts=['<option value="">无</option>'].concat(cats.map(c=>`<option value="${c.key}">${c.name}</option>`)).join('');
    $$('#gridBody select[data-k="row_color"]').forEach(sel=>{ const cur=sel.value; sel.innerHTML=opts; sel.value=cur; });
  }
  async function render(){
    const kw=($('#q').value||'').trim().toLowerCase();
    const fOwner=$('#filterOwner').value; const fWx=$('#filterWxReal').value;
    const sortBy=$('#sortBy').value;
    let all=await dbLocal.rows.toArray();

    all=all.filter(r=>{
      if(fOwner!=='all' && (r.owner||'')!==fOwner) return false;
      if(fWx!=='all' && (r.wx_real||'')!==fWx) return false;
      if(!kw) return true;
      const t=[r.phone,r.owner,r.wx_real,r.wx_name,r.xhs_name,r.note1,catNameOf(r.row_color)].join(' ').toLowerCase();
      return t.includes(kw);
    });

    const collator=new Intl.Collator('zh-Hans-CN',{numeric:true,sensitivity:'base'});
    if(sortBy==='order') all.sort((a,b)=> (a.order||0)-(b.order||0));
    else all.sort((a,b)=> collator.compare(String(a[sortBy]||''), String(b[sortBy]||'')));

    const body=$('#gridBody'); body.innerHTML='';
    all.forEach(r=> body.appendChild(makeRowTr(r)));
    await ensureCatOptions();
    $$('#gridBody tr').forEach(tr=>{ const id=tr.dataset.id; dbLocal.rows.get(id).then(r=>{ const sel=tr.querySelector('select[data-k="row_color"]'); if(sel) sel.value=r && r.row_color ? r.row_color : ''; }); });
    refreshFilters();
  }

  /* 顺序与 CRUD */
  async function reindexOrders(){
    const list=await dbLocal.rows.orderBy('order').toArray();
    await dbLocal.transaction('rw', dbLocal.rows, async ()=>{
      for(let i=0;i<list.length;i++){
        await dbLocal.rows.update(list[i].id,{order:i+1,updated_at:new Date().toISOString()});
      }
    });
  }
  async function addRowLocalAt(index){
    const total=await dbLocal.rows.count();
    const list=await dbLocal.rows.orderBy('order').toArray();
    const order = (index<=0)? 0.5 : (index>=total? (total+0.5) : ( (list[index-1]?.order||0) + 0.5 ));
    const r={ id:crypto.randomUUID(), order, phone:'', owner:'', wx_real:'', wx_name:'', xhs_name:'', note1:'', row_color:'', created_at:new Date().toISOString(), updated_at:new Date().toISOString() };
    await dbLocal.rows.put(r); await reindexOrders(); await render();
  }
  async function addRowLocal(){ const total=await dbLocal.rows.count(); await addRowLocalAt(total); } // 兼容
  async function updateCellLocal(id,key,value){ const r=await dbLocal.rows.get(id); if(!r) return; const patch={}; patch[key]=value; patch.updated_at=new Date().toISOString(); await dbLocal.rows.update(id, patch); await render(); }
  async function deleteRowLocal(id){ await dbLocal.rows.delete(id); await render(); }
  async function moveRow(id, dir){
    const all=await dbLocal.rows.orderBy('order').toArray();
    const idx=all.findIndex(x=>x.id===id); if(idx<0) return;
    const tgt=dir==='up'? idx-1:idx+1; if(tgt<0||tgt>=all.length) return;
    const a=all[idx], b=all[tgt];
    await dbLocal.rows.update(a.id,{order:b.order,updated_at:new Date().toISOString()});
    await dbLocal.rows.update(b.id,{order:a.order,updated_at:new Date().toISOString()});
    await render();
  }

  /* CSV */
  function parseCSV(text, delim){ const rows=[]; let cur='', inQ=false, row=[]; for(let i=0;i<text.length;i++){ const ch=text[i], next=text[i+1]; if(ch=='"'){ if(inQ && next=='"'){ cur+='"'; i++; } else inQ=!inQ; } else if(ch===delim && !inQ){ row.push(cur); cur=''; } else if((ch=='\n'||ch=='\r') && !inQ){ if(cur!==''||row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } if(ch=='\r' && next=='\n'){ i++; } } else { cur+=ch; } } if(cur!==''||row.length){ row.push(cur); rows.push(row); } return rows; }
  function detectDelimiter(text){ const sample=text.slice(0,10000); const cand=[',','\t',';','|']; const cnt={',':0,'\t':0,';':0,'|':0}; let inQ=false; for(let i=0;i<sample.length;i++){ const ch=sample[i]; if(ch=='"'){ inQ=!inQ; continue; } if(!inQ && cnt.hasOwnProperty(ch)) cnt[ch]++; } let best=',',max=-1; for(const k of cand){ if(cnt[k]>max){ max=cnt[k]; best=k; } } return best; }
  function mapHeader(h){ const t=(h||'').toLowerCase().trim(); const table={ phone:['电话号码','电话','手机号','phone','mobile','号码'], owner:['所属人','owner','归属','持有人'], wx_real:['微信实名人','实名人','wx_real','微信实名'], wx_name:['对应微信名','微信名','wx_name'], xhs_name:['小红书名称','小红书名','xhs','xhs_name'], note1:['备注','备注1','note','note1'], row_color:['分类','颜色','row_color','color','类别'] }; for(const k in table){ if(table[k].some(x=>t.includes(x))) return k; } return null; }
  async function importCSVText(text){
    const delim=detectDelimiter(text); const rows=parseCSV(text, delim);
    let headerRow=0; for(let i=0;i<Math.min(rows.length,20);i++){ const j=(rows[i]||[]).join(' ').toLowerCase(); if(j.includes('电话')||j.includes('phone')||j.includes('小红书')||j.includes('备注')){ headerRow=i; break; } }
    if(headerRow>0){ rows.splice(0, headerRow); }
    const headers=(rows[0]||[]).map(mapHeader);
    if(!headers.some(h=>h==='phone')){ alert('没有找到“电话号码/phone”的表头'); return; }
    const count=await dbLocal.rows.count();
    const existingRows = await dbLocal.rows.toArray();
    const normPhone = (p)=>String(p||'').replace(/\D+/g,'');
    const existed = new Set(existingRows.map(r=>normPhone(r.phone)));
    const seen = new Set();
    let skipped=0; const data=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]||[]; if(r.every(c=>String(c||'').trim()==='')) continue;
      const obj={ id:crypto.randomUUID(), order:count+i, created_at:new Date().toISOString(), updated_at:new Date().toISOString() };
      headers.forEach((k,idx)=>{ if(!k) return; const raw=(r[idx]===undefined?'':String(r[idx])); const v=raw.trim(); const low=v.toLowerCase(); obj[k]=(low==='nan'||low==='null'||low==='-'?'':v); });
      const key = normPhone(obj.phone);
      if (key && (existed.has(key) || seen.has(key))) { skipped++; } else { if (key) seen.add(key); data.push(obj); }
    }
    if(!data.length){ alert('没有可导入的数据'); return; }
    await dbLocal.rows.bulkPut(data); await render();
    alert('本地已导入 '+data.length+' 行，跳过重复 '+skipped+' 行（按电话号码去重）');
  }

  /* 面板开关 & 新增三选项 */
  function togglePanel(btnEl, panelEl){
    const show = panelEl.style.display==='none';
    ['panelCategories','panelView','panelDebug'].forEach(id=>{
      const p = document.getElementById(id);
      const b = (id==='panelCategories')? $('#btnCategories') : (id==='panelView')? $('#btnView') : $('#btnDebug');
      if(p && p!==panelEl){ p.style.display='none'; if(b) b.classList.remove('active'); }
    });
    panelEl.style.display = show?'block':'none';
    if(btnEl){ btnEl.classList.toggle('active', show); }
  }
  function setupAddMenu(){
    const btn = $('#btnAdd'); if(!btn) return;
    if (document.getElementById('addMenu')) return;
    const menu = document.createElement('div');
    Object.assign(menu,{ id:'addMenu' });
    Object.assign(menu.style,{
      position:'absolute', zIndex:'10', display:'none', background:'#fff', border:'1px solid var(--line)',
      borderRadius:'10px', boxShadow:'0 10px 24px rgba(0,0,0,.08)', padding:'8px'
    });
    menu.innerHTML=`
      <div style="display:flex;flex-direction:column;gap:6px;min-width:136px">
        <button class="ghost" data-pos="top">首行新增</button>
        <button class="ghost" data-pos="mid">中间新增</button>
        <button class="ghost" data-pos="bottom">末行新增</button>
      </div>`;
    document.body.appendChild(menu);

    const place = ()=>{
      const r=btn.getBoundingClientRect();
      menu.style.left = (window.scrollX + r.left)+'px';
      menu.style.top  = (window.scrollY + r.bottom + 6)+'px';
    };
    btn.addEventListener('click', (e)=>{
      e.stopPropagation(); place();
      menu.style.display = (menu.style.display==='none')?'block':'none';
    });
    document.addEventListener('click', ()=>{ menu.style.display='none'; });

    menu.addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-pos]'); if(!b) return;
      const total = await dbLocal.rows.count();
      if(b.dataset.pos==='top') await addRowLocalAt(0);
      else if(b.dataset.pos==='bottom') await addRowLocalAt(total);
      else { const mid=Math.floor(total/2); await addRowLocalAt(mid); }
      menu.style.display='none';
    });
  }

  /* 云端 */
  function setCloudStatus(ok, text){ const d=$('#cloudDot'), t=$('#cloudText'); if(d) d.style.background=ok?'#20c997':'#d9534f'; if(t) t.textContent=text||(ok?'云端已连接':'离线'); }
  async function timedFetch(url, opts, ms){ const ctl=new AbortController(); const timer=setTimeout(()=>ctl.abort(), ms||12000); try{ const r=await fetch(url,{signal:ctl.signal,...(opts||{})}); clearTimeout(timer); return r; }catch(e){ clearTimeout(timer); throw e; } }
  async function secureFetch(url, opts){ const headers=Object.assign({}, (opts&&opts.headers)||{}, {'X-Access-Key': ACCESS_KEY}); try{ return await timedFetch(url, {...(opts||{}), headers}, 12000); }catch(e){ setCloudStatus(false,'网络异常'); throw e; } }
  window.cloudLoad = async function(){ try{ const rsp=await secureFetch(WORKER_URL,{method:'GET',cache:'no-store'}); if(!rsp.ok){ const txt=await rsp.text().catch(()=>''); setCloudStatus(false,'读取失败'); alert('云端读取失败：'+rsp.status+(txt?(' '+txt):'')); return null; } const data=await rsp.json(); setCloudStatus(true,'云端已连接'); alert('已从云端读取'); return data; }catch(e){ alert('云端读取异常'); return null; } };
  window.cloudSave = async function(payload){ try{ const rsp=await secureFetch(WORKER_URL,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!rsp.ok){ const txt=await rsp.text().catch(()=> ''); setCloudStatus(false,'保存失败'); alert('云端保存失败：'+rsp.status+(txt?(' '+txt):'')); return false; } setCloudStatus(true,'已同步'); alert('云端保存成功'); return true; }catch(e){ alert('云端保存异常'); return false; } };

  /* 验证徽章 */
  (function(){
    function buf2hex(buffer){ const bytes = new Uint8Array(buffer); return Array.prototype.map.call(bytes, x => ('00' + x.toString(16)).slice(-2)).join(''); }
    async function sha256hex(str){ const enc = new TextEncoder(); const data = enc.encode(str); const hash = await crypto.subtle.digest('SHA-256', data); return buf2hex(hash); }
    const PWD_SHA256 = '5bcbba0a49881aa3b1147bd26a19c94a71fde15a844c942515b107b399d6a4db';
    const WH_LOCAL_KEY = 'xhs_whitelist_v1';
    const WH_SESSION_KEY = 'xhs_whitelist_sess_v1';
    function findBadge(){ let el=$('#verifyStatus'); if(el) return el; return Array.from(document.querySelectorAll('span,button,div')).find(n=>['未验证','已验证白名单'].includes((n.textContent||'').trim()))||null; }
    function isWhite(){ return sessionStorage.getItem(WH_SESSION_KEY)==='1' || localStorage.getItem(WH_LOCAL_KEY)==='1'; }
    function setWhite(){ try{ sessionStorage.setItem(WH_SESSION_KEY,'1'); }catch(e){} try{ localStorage.setItem(WH_LOCAL_KEY,'1'); }catch(e){} }
    function refresh(el){ if(!el) return; el.textContent=isWhite()?'已验证白名单':'未验证'; el.style.cursor='pointer'; el.title='点击输入密码加入白名单'; }
    function setup(){ const el=findBadge(); if(!el||el.__ok) return; el.__ok=true; refresh(el); el.addEventListener('click', async()=>{ const p=prompt('请输入访问密码：'); if(!p) return; const ok=(await sha256hex(p.trim()))===PWD_SHA256; if(ok){ setWhite(); alert('验证成功，本设备加入白名单'); }else{ alert('密码错误'); } refresh(el); }); }
    document.addEventListener('DOMContentLoaded', ()=>{ setup(); setTimeout(setup, 700); });
  })();

  /* 分类 UI */
  function renderCatList(){
    const cats=readCats(), box=$('#catList'); box.innerHTML='';
    cats.forEach((c,idx)=>{
      const row=document.createElement('div'); row.className='cat-row';
      row.innerHTML=`
        <span class="namePill"><span class="colorDot" style="background:${c.color}"></span>${c.name}</span>
        <span class="spacer"></span>
        <button class="ghost" data-act="up"        data-i="${idx}">上移</button>
        <button class="ghost" data-act="down"      data-i="${idx}">下移</button>
        <button class="ghost" data-act="editName"  data-i="${idx}">改名</button>
        <button class="ghost" data-act="editColor" data-i="${idx}">改颜色</button>
        <button class="ghost" data-act="del"       data-i="${idx}">删除</button>`;
      box.appendChild(row);
    });
  }
  function bindCategoryEvents(){
    const nameI=$('#catName'), colorI=$('#catColor'), preview=$('#catColorPreview')||colorI;
    if(colorI && preview){ colorI.addEventListener('input',()=>{ preview.style.background=colorI.value||'#ccc'; }); }
    const btnAdd=$('#btnCatAdd');
    if(btnAdd && !btnAdd.__wired){
      btnAdd.__wired=true;
      const add=()=>{
        const name=(nameI&&nameI.value||'').trim(); const color=(colorI&&colorI.value)||'#cccccc';
        if(!name){ if(nameI) nameI.focus(); return; }
        const cats=readCats();
        const base=(name.toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]+/g,'').slice(0,24) || 'cat');
        let key=base, n=1; while(cats.some(x=>x.key===key)) key=base+'_'+(++n);
        cats.push({key,name,color}); saveCats(cats);
        if(nameI) nameI.value='';
        renderCatList(); ensureCatOptions();
      };
      btnAdd.addEventListener('click', add);
      if(nameI){ nameI.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); add(); } }); }
    }
    const list=$('#catList');
    if(list && !list.__wired){
      list.__wired=true;
      list.addEventListener('click',(e)=>{
        const b=e.target.closest('button[data-act]'); if(!b) return;
        const i=parseInt(b.dataset.i,10); const act=b.dataset.act;
        const cats=readCats(); if(isNaN(i)||i<0||i>=cats.length) return;
        if(act==='up' && i>0){ [cats[i-1],cats[i]]=[cats[i],cats[i-1]]; saveCats(cats); renderCatList(); ensureCatOptions(); return; }
        if(act==='down' && i<cats.length-1){ [cats[i+1],cats[i]]=[cats[i],cats[i+1]]; saveCats(cats); renderCatList(); ensureCatOptions(); return; }
        if(act==='editName'){
          const nn=prompt('分类名称', cats[i].name);
          if(nn!==null){ cats[i].name=(nn||'').trim()||cats[i].name; saveCats(cats); renderCatList(); ensureCatOptions(); }
          return;
        }
        if(act==='editColor'){
          const cc=prompt('颜色（十六进制，如 #ff6699）', cats[i].color);
          if(cc){ cats[i].color=cc; saveCats(cats); renderCatList(); ensureCatOptions(); }
          return;
        }
        if(act==='del'){
          if(confirm(`删除分类：${cats[i].name}？`)){
            const delKey=cats[i].key; cats.splice(i,1); saveCats(cats);
            $$('select[data-k="row_color"]').forEach(sel=>{ if(sel.value===delKey) sel.value=''; });
            renderCatList(); ensureCatOptions();
          }
          return;
        }
      });
    }
  }

  /* 事件绑定 */
  document.addEventListener('DOMContentLoaded', async function(){
    const view = readView(); applyView(view);

    /* —— 搜索 / 排序 / 筛选 —— */
    $('#q').addEventListener('input', render);
    $('#filterOwner').addEventListener('change', render);
    $('#filterWxReal').addEventListener('change', render);
    $('#sortBy').addEventListener('change', render);

    /* —— 清空全部 —— */
    $('#btnClearAll').addEventListener('click', async ()=>{
      if(!confirm('确定清空全部数据？此操作不可撤销。')) return;
      await dbLocal.rows.clear(); await render(); alert('已清空全部数据');
    });

    /* 视图控件 */
    $('#rowPad').oninput =(e)=>{ view.pad=parseInt(e.target.value,10); applyView(view); saveView(view); };
    $('#colScale').oninput=(e)=>{ view.colScale=parseFloat(e.target.value); applyView(view); saveView(view); };
    $('#zebraOn').onchange=(e)=>{ view.zebraOn=e.target.checked; applyView(view); saveView(view); };
    $('#zebraColor').oninput=(e)=>{ view.zebraColor=e.target.value; applyView(view); saveView(view); };

    /* CSV */
    $('#btnImportCSV').onclick=()=> $('#csvFile').click();
    $('#csvFile').onchange=async (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; const text=await f.text(); await importCSVText(text); e.target.value=''; };

    /* 新增三选项 */
    setupAddMenu();

    /* 顶部面板按钮高亮 */
    $('#btnCategories').onclick=()=> togglePanel($('#btnCategories'), $('#panelCategories'));
    $('#btnView').onclick=()=> togglePanel($('#btnView'), $('#panelView'));
    $('#btnDebug').onclick=()=> togglePanel($('#btnDebug'), $('#panelDebug'));

    /* 表格委托（含互斥编辑 3 行） */
    $('#gridBody').addEventListener('blur', async (e)=>{ const td=e.target.closest('[contenteditable="true"]'); if(!td) return; const tr=e.target.closest('tr'); const id=tr.dataset.id; const key=td.dataset.k; const val=td.innerText.trim(); await updateCellLocal(id, key, val); }, true);
    $('#gridBody').addEventListener('change', async (e)=>{ const sel=e.target.closest('select[data-k]'); if(!sel) return; const tr=sel.closest('tr'); await updateCellLocal(tr.dataset.id, sel.dataset.k, sel.value); });
    $('#gridBody').addEventListener('click', async (e)=>{
      const btn=e.target.closest('button[data-act]'); if(!btn) return;
      const tr=btn.closest('tr'); const id=tr.dataset.id; const act=btn.dataset.act;
      if(act==='toggleEdit'){
        const was=tr.classList.contains('row-editing');
        $$('#gridBody tr.row-editing').forEach(el=>{ if(el!==tr) el.classList.remove('row-editing'); }); // 互斥①
        tr.classList.toggle('row-editing', !was); // 互斥②
        return; // 互斥③
      }
      if(act==='del'){ if(confirm('确认删除该行？')) await deleteRowLocal(id); return; }
      if(act==='up'){ await moveRow(id,'up'); return; }
      if(act==='down'){ await moveRow(id,'down'); return; }
    });

    await dbLocal.open(); await render();

    /* 分类区 */
    renderCatList(); bindCategoryEvents();

    /* 云端按钮 */
    const s=$('#btnSaveCloud'), l=$('#btnLoadCloud'), exp=$('#btnExportCSV');
    if(s && !s.__w){ s.__w=true; s.addEventListener('click', async()=>{ try{ const rows=await dbLocal.rows.toArray(); const cats=JSON.parse(localStorage.getItem('cats_v6')||'[]'); const view=JSON.parse(localStorage.getItem('view_v6')||'{}'); const payload={rows,cats,view,ver:1,updated_at:new Date().toISOString()}; await cloudSave(payload); }catch{ alert('准备保存数据失败'); } }); }
    if(l && !l.__w){ l.__w=true; l.addEventListener('click', async()=>{ const data=await cloudLoad(); if(data){ try{ await dbLocal.rows.clear(); if(Array.isArray(data.rows)&&data.rows.length) await dbLocal.rows.bulkPut(data.rows); if(Array.isArray(data.cats)) localStorage.setItem('cats_v6', JSON.stringify(data.cats)); if(data.view&&typeof data.view==='object') localStorage.setItem('view_v6', JSON.stringify(data.view)); await render(); alert('已应用云端数据'); }catch{ alert('写入本地失败'); } } }); }
    if(exp && !exp.__w){ exp.__w=true; exp.addEventListener('click', async()=>{ try{ const rows = await dbLocal.rows.toArray(); const cols=['phone','owner','wx_real','wx_name','xhs_name','note1','row_color']; const esc=v=>{const s=(v==null?'':String(v)).replace(/"/g,'""'); return /[",\n]/.test(s)?'"'+s+'"':s;}; const lines=[cols.join(',')]; rows.forEach(r=>lines.push(cols.map(k=>esc(r[k]||'')).join(','))); const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='xhs-phones-'+Date.now()+'.csv'; a.click(); alert('已导出 CSV'); }catch{ alert('导出失败'); } }); }
    /* 连通性 */
    (async ()=>{ try{ const r=await fetch(WORKER_URL,{method:'GET',headers:{'X-Access-Key':ACCESS_KEY},cache:'no-store'}); setCloudStatus(r.ok, r.ok?'云端已连接':'连接失败'); }catch{ setCloudStatus(false,'离线'); } })();
  });
})();
</script>

<!-- 调试日志容器 -->
<div class="panel" id="panelDebug" style="display:none"><div class="status" id="debug"></div></div>

</body>
</html>
